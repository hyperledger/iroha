name: Iroha1

on:
  # push:
  #   branches: [ main, support/1.2.x ]
  pull_request:
    # branches: [ main, support/1.2.x ]  ## target branches
  workflow_dispatch:
    ## NOTE: Able to run via cmdline: gh workflow run Iroha1
    inputs:
      whatever:
        description: 'some-string.'
        required: true
        default: 'hello world!'
  issue_comment:
    types: [created, edited]

jobs:
  Docker-iroha-builder:
    # if: ${{ false }}  # disable for now
    runs-on: [ self-hosted, Linux ]
    steps:
      - &step_show_context
        name: Show context
        run: |
          set +e  ## allow jq to fail
          cat <<'END'
            ${{ toJson(github) }}
          END
        #  apt-get -y --no-install-recommends install jq  ## for self-hosted
        #  jq <<'END'
        #    ${{ toJson(github) }}
        #  END
      - &step_if_comment_on_pull_request
        id: comment_on_pull_request
        if: ${{ github.event.issue.pull_request &&
              startsWith(github.event.comment.body, '/buildme') }}
        run: |
          echo COMMENT_ON_PULL_REQUEST=true >>$GITHUB_ENV
          curl ${{github.event.issue.pull_request.url}} |
            jq -r '"REF="+.head.ref, "SHA="+ .head.sha' >>$GITHUB_ENV
      - &step_info
        name: Build info
        run: |
          cat << 'END'
          ref:${{github.ref}}
          sha:${{github.sha}}
          run_number:${{github.run_number}}
          event_name:${{github.event_name}}
          event.action:${{github.event.action}}
          event.issue.number:${{ github.event.issue.number }}
          env.REF:${{env.REF}}
          env.SHA:${{env.SHA}}
          END
      - &step_system_info
        name: System info
        run: |
          whoami
          df -h
      - &step_cancel_previous_runs
        if: ${{false}}
        name: Cancel Previous Workflow Runs
        uses: n1hility/cancel-previous-runs@v2.0
        with:
          token: ${{ github.token }}
      - &step_checkout
        name: Checkout
        uses: actions/checkout@v2
        with:
          ref: ${{env.REF}}
      - run: |
          git clone https://github.com/sobolevn/git-secret.git git-secret
          cd git-secret
          make build
          echo PATH=$PWD:$PATH >>$GITHUB_ENV
          #PREFIX=/usr/local make install  ## no access
      -
        if: ${{false}}
        name: Git-secret to ENV
        run: |
          echo "${{secrets.GPG_KEY_TO_GIT_SECRET}}" | gpg --import    ###tr , '\n' | gpg --import
          git secret reveal
          cat .github/dockerhub.env
          cat .github/dockerhub.env >>$GITHUB_ENV
        ## todo get secrets.DOCKERHUB_USERNAME from env.DOCKERHUB_USERNAME
      -
        name: Determine dockertag
        id: dockertag
        run: echo "::set-output name=dockertag::${{ hashFiles('docker/develop/Dockerfile.builder') }}"
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      -
        name: Cache Docker layers
        uses: actions/cache@v2
        with:
          path: /tmp/.buildx-cache
          key:           ${{ runner.os }}-buildx-${{steps.dockertag.outputs.dockertag}}
          restore-keys:  ${{ runner.os }}-buildx-
      -
        name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      -
        name: Build and push
        uses: docker/build-push-action@v2
        with:
          file: docker/develop/Dockerfile.builder
          # context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_ORG }}/iroha-builder:${{steps.dockertag.outputs.dockertag}}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new
      -
        # Temp fix
        # https://github.com/docker/build-push-action/issues/252
        # https://github.com/moby/buildkit/issues/1896
        name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache
      -
        name: Delay before pulling built image by next job
        run: sleep 10
    outputs:
      dockertag: ${{steps.dockertag.outputs.dockertag}}

  ## Build in a docker container
  build-iroha-ubuntu:
    # if: ${{ event_name == 'workflow_dispatch' and }}
    needs: Docker-iroha-builder
    runs-on: [ self-hosted, Linux ] #ubuntu-latest
    container: ikyb/iroha-builder:${{needs.Docker-iroha-builder.outputs.dockertag}}
    strategy:
      fail-fast: false
      matrix:
        cc: [ gcc-9, gcc-10, clang-10 ]
        # os: [ macos-latest, macos-11.0, macos-10.15 ]
        USE_BURROW: [ -DUSE_BURROW=OFF ]
        # USE_URSA: [ -DUSE_URSA=OFF ]
        ## FIXME USE_BURROW=ON Fails on macos https://github.com/kuvaldini/iroha/runs/2489119287?check_suite_focus=true
        build_type: [ Debug ] #,Release, RelWithDebInfo
    steps: &build_steps
      - *step_show_context
      - *step_if_comment_on_pull_request
      - *step_info
      - *step_cancel_previous_runs
      - &step_export_cxx
        name: export CC and CXX
        run: |
          echo CC=${{ matrix.cc }}                                                >>$GITHUB_ENV
          echo CXX=$(echo ${{ matrix.cc }} | sed -es,gcc,g++, -es,clang,clang++,) >>$GITHUB_ENV
      - &step_todo_remove
        name: Check exported CC and CXX, TODO remove this step
        run: echo CC=$CC CXX=$CXX
      - *step_checkout
      - &step_vcpkg_cache
        ## Read the docs https://github.com/microsoft/vcpkg/blob/master/docs/users/binarycaching.md
        name: Cache vcpkg
        uses: actions/cache@v2
        with:
          path: |
            build-vcpkg
            build/vcpkg_installed
            $HOME/.cache/vcpkg
          key:          ${{ runner.os }}-vcpkg-${{ github.sha }}
          restore-keys: ${{ runner.os }}-vcpkg-
      - &step_vcpkg_build
        name: Build iroha vcpkg dependancies
        run: ./vcpkg/build_iroha_deps.sh $PWD/build-vcpkg
        ## Takes 48m16s on default GitHub runner with 2 cores
        # ________________________________________________________
        # Executed in   32,08 mins    fish           external
        #    usr time  110,52 mins    0,24 millis  110,52 mins
        #    sys time   12,26 mins    1,34 millis   12,26 mins
        #
        # All requested packages are currently installed.
        # ________________________________________________________
        # Executed in    3,17 secs    fish           external
        #    usr time    2,05 secs  128,00 micros    2,05 secs
        #    sys time    0,70 secs  575,00 micros    0,70 secs
      - &step_cmake_configure
        name: CMake configure
        run: >
          cmake -B build -DCMAKE_TOOLCHAIN_FILE=$PWD/build-vcpkg/scripts/buildsystems/vcpkg.cmake
          -GNinja ${{ matrix.USE_BURROW }}
          #-DCMAKE_VERBOSE_MAKEFILE=ON
        ## Takes 13s on regular GitHub runner
      - &step_cmake_build
        name: CMake build
        run: cmake --build build --config ${{ matrix.build_type }} -- -j$(nproc | awk '{printf("%.0f",$1*0.77)}')
        ## Takes 18m44s on regular GitHub runner
      - &step_always_after_build
        name: Show free space and disk usage
        if: ${{ always() }}
        run: |
          set +e
          df -h
          echo; echo ----------------------; echo
          du -hd2 /
          true
      - &step_artifact_irohad
        name: Archive artifact irohad
        uses: actions/upload-artifact@v2
        with:
          name: irohad
          path: build/bin/irohad
      - &step_artifact_tests
        name: Archive artifact irohad
        uses: actions/upload-artifact@v2
        with:
          name: iroha-tests
          path: |
            build/test_bin/**
            build/test_data/**
      - &step_ctest
        # if: ${{ false }}  # disable for now
        name: CTest
        run: |
          set -eu
          pg_ctlcluster 12 main start
          ###initdb --locale=C -E UTF-8 $PWD/postgres_database
          ###pg_ctl -D $PWD/postgres_database start #& { sleep .3; kill -0 $!; }
          cd build && ctest --output-on-failure #--progress
        ## Takes over 4h on regular GitHub runner
      - &step_artifact_test_results
        name: Archive artifact irohad
        uses: actions/upload-artifact@v2
        with:
          name: iroha-test-results-todo
          paths:

  build-iroha-macos:
    # if: ${{ false }}  # disable for now
    runs-on: macos-latest #[ self-hosted, MacOS ] #
    strategy:
      fail-fast: false
      matrix:
        cpp: [ clang++ ] #, /usr/local/opt/llvm/bin/clang++, g++-10 ]
        # os: [ macos-latest, macos-11.0, macos-10.15 ]
        USE_BURROW: [ -DUSE_BURROW=OFF ]
        # USE_URSA: [ -DUSE_URSA=OFF ]
        ## FIXME USE_BURROW=ON Fails on macos https://github.com/kuvaldini/iroha/runs/2489119287?check_suite_focus=true
        build_type: [ Debug ] #,Release, RelWithDebInfo
    steps:
      - *step_show_context
      # - *step_if_comment_on_pull_request
      - *step_info
      - *step_cancel_previous_runs
      - *step_export_cxx
      -
        name: Homebrew
        run: brew install cmake ninja coreutils
        ## Takes 22 seconds with default github runner
      -
        if: ${{matrix.cpp == 'g++-10'}}
        name: Homebrew GCC
        run: brew install gcc@10
      -
        if: ${{matrix.cpp == '/usr/local/opt/llvm/bin/clang++'}}
        name: Homebrew LLVM
        run: brew install llvm
      - *step_checkout
      - *step_vcpkg_cache
      - *step_vcpkg_build
      - *step_cmake_configure
      - *step_cmake_build
      - *step_artifact_irohad
      - *step_artifact_tests
      - &step_brew_postgres
        name: Install Postgres on MacOS
        run: brew install postgresql
        ## ToDo may be optimize, i.e. cache package
      - <<: *step_ctest
        run: |
          initdb --locale=C -E UTF-8 $PWD/postgres_database
          postgres -D $PWD/postgres_database & { sleep .3; kill -0 $!; }
          cd build
          ctest --output-on-failure #--progress

  build-iroha-windows:
    if: ${{ false }}  # disable for now
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        # cpp: [ cl, clang++, mingw++ ]
        # USE_BURROW: [ -DUSE_BURROW=OFF ]
        # USE_URSA: [ -DUSE_URSA=OFF ]
        ## FIXME USE_BURROW=ON Fails on macos https://github.com/kuvaldini/iroha/runs/2489119287?check_suite_focus=true
        build_type: [ Debug ] #,Release, RelWithDebInfo
    steps:
      # - *cancel_previous_runs
      - name: uname in bash
        run: uname
        shell: bash
      - name: uname in default shell
        run: uname
      # - &step_choco_install
      #   name: Chocolatey install
      #   run: choco install cmake ninja
      - *step_checkout
      #- *step_vcpkg_cache
      - <<: *step_vcpkg_build
        shell: bash
      - *step_cmake_configure
      - <<: *step_cmake_build
        shell: bash
      -
        name: Install Postgres on Windows
        run: choco install postgresql
      # - *step_ctest
